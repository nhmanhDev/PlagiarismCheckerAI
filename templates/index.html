<!doctype html>
<html lang="vi">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>{{ title }}</title>
	<link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
	<div class="container">
		<h1>üßê AI Plagiarism Checker</h1>
		<p><small>Thi·∫øt b·ªã: <strong>{{ device | default('cpu') | upper }}</strong></small></p>

		<footer>
			<hr />
			<small>
				Ch·∫ø ƒë·ªô: Hybrid Retrieval (BM25 + Semantic)
			</small>
		</footer>
	</div>

	<script>
	// Classifier nhanh t·∫°m ·∫©n

	// --- Hybrid Retrieval UI ---
	// Add dynamic section for corpus and hybrid checking
	(function setupHybrid() {
		const container = document.querySelector('.container');
		const hybridHtml = `
			<section>
				<h2>üìö Thi·∫øt l·∫≠p kho tham chi·∫øu (Corpus)</h2>
				<form id="corpus-form" method="post" action="/api/hybrid_set_corpus">
					<div class="field">
						<label for="corpus">D√°n vƒÉn b·∫£n/kho tham chi·∫øu (c√°c ƒëo·∫°n g·ªëc)</label>
						<textarea id="corpus" name="corpus" rows="10" placeholder="D√°n c√°c ƒëo·∫°n vƒÉn b·∫£n ngu·ªìn, c√≥ th·ªÉ nhi·ªÅu ƒëo·∫°n." required></textarea>
					</div>
					<div class="field">
						<label for="split_mode">C√°ch t√°ch ƒëo·∫°n</label>
						<select id="split_mode" name="split_mode">
							<option value="auto" selected>Auto (c√¢u)</option>
							<option value="sentence">C√¢u</option>
							<option value="paragraph">ƒêo·∫°n</option>
						</select>
					</div>
					<button type="submit">L·∫≠p ch·ªâ m·ª•c corpus</button>
				</form>
				<div id="corpus-status" style="display:none" class="result">
					<p><strong>Tr·∫°ng th√°i:</strong> ƒê√£ l·∫≠p ch·ªâ m·ª•c <span id="num-segments">0</span> segment(s). Thi·∫øt b·ªã: <span id="device-name">‚Äî</span></p>
				</div>
			</section>

			<section>
				<h2>üîé Ki·ªÉm tra ƒë·∫°o vƒÉn ki·ªÉu Hybrid</h2>
				<form id="hybrid-form" method="post" action="/api/hybrid_check">
					<div class="field">
						<label for="query_text">VƒÉn b·∫£n nghi ng·ªù</label>
						<textarea id="query_text" name="query_text" rows="8" placeholder="D√°n ƒëo·∫°n nghi ng·ªù‚Ä¶" required></textarea>
					</div>
					<div class="field">
						<label>Tham s·ªë</label>
						<div style="display:grid;grid-template-columns: repeat(2, minmax(0,1fr)); gap: 12px;">
							<label>alpha (k·∫øt h·ª£p): <input type="number" step="0.05" min="0" max="1" name="alpha" value="0.4" /></label>
							<label>top_k_lex: <input type="number" min="1" name="top_k_lex" value="10" /></label>
							<label>top_k_sem: <input type="number" min="1" name="top_k_sem" value="10" /></label>
							<label>top_n: <input type="number" min="1" name="top_n" value="5" /></label>
							<label>threshold: <input type="number" step="0.01" min="0" max="1" name="threshold" value="0.75" /></label>
						</div>
					</div>
					<button type="submit">Ch·∫°y Hybrid Retrieval</button>
				</form>
				<div id="hybrid-results" style="display:none" class="result">
					<h3>K·∫øt qu·∫£ Hybrid</h3>
					<pre id="hybrid-meta"></pre>
					<div id="hybrid-table"></div>
				</div>
			</section>
		`;
		const wrapper = document.createElement('div');
		wrapper.innerHTML = hybridHtml;
		container.appendChild(wrapper);

		const corpusForm = document.getElementById('corpus-form');
		const corpusStatus = document.getElementById('corpus-status');
		const numSegEl = document.getElementById('num-segments');
		const deviceNameEl = document.getElementById('device-name');

		corpusForm.addEventListener('submit', async (e) => {
			e.preventDefault();
			const fd = new FormData(corpusForm);
			try {
				const res = await fetch('/api/hybrid_set_corpus', { method: 'POST', body: fd });
				if (!res.ok) throw new Error(await res.text());
				const data = await res.json();
				numSegEl.textContent = String(data.num_segments ?? 0);
				deviceNameEl.textContent = String(data.device ?? '‚Äî').toUpperCase();
				corpusStatus.style.display = 'block';
			} catch (err) {
				alert('L·ªói l·∫≠p ch·ªâ m·ª•c corpus: ' + String(err));
			}
		});

		const hybridForm = document.getElementById('hybrid-form');
		const hybridBox = document.getElementById('hybrid-results');
		const hybridMeta = document.getElementById('hybrid-meta');
		const hybridTable = document.getElementById('hybrid-table');

		hybridForm.addEventListener('submit', async (e) => {
			e.preventDefault();
			const fd = new FormData(hybridForm);
			try {
				const res = await fetch('/api/hybrid_check', { method: 'POST', body: fd });
				if (!res.ok) throw new Error(await res.text());
				const data = await res.json();
				hybridMeta.textContent = JSON.stringify({ alpha: data.alpha, threshold: data.threshold, device: data.device }, null, 2);
				const confirmations = {};
				(data.confirmations || []).forEach(c => { confirmations[c.index] = c; });
				const rows = (data.results || []).map((r, i) => {
					return `
						<tr>
							<td>${i+1}</td>
							<td>${r.score_final.toFixed(3)}</td>
							<td>${r.score_lexical_raw.toFixed(3)}</td>
							<td>${r.score_semantic_raw.toFixed(3)}</td>
								<td>${r.is_suspected ? '1' : '0'}</td>
							<td><pre style="white-space:pre-wrap;margin:0">${r.text}</pre></td>
						</tr>`;
				}).join('');
				hybridTable.innerHTML = `
					<table style="width:100%; border-collapse: collapse;">
						<thead>
							<tr>
								<th>#</th>
								<th>Score (final)</th>
								<th>BM25 (raw)</th>
								<th>Semantic (raw)</th>
								<th>Nghi ng·ªù</th>
								<th>ƒêo·∫°n vƒÉn</th>
								
							</tr>
						</thead>
						<tbody>${rows}</tbody>
					</table>`;
				hybridBox.style.display = 'block';
			} catch (err) {
				alert('L·ªói hybrid check: ' + String(err));
			}
		});
	})();
	</script>
</body>
</html>
